<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#ffffff">
  <title>Helm - Productivity</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    
    :root {
      --blue-600: #2563eb;
      --blue-500: #3b82f6;
      --blue-400: #60a5fa;
      --blue-100: #dbeafe;
      --blue-50: #eff6ff;
      --gray-900: #111827;
      --gray-700: #374151;
      --gray-500: #6b7280;
      --gray-400: #9ca3af;
      --gray-300: #d1d5db;
      --gray-200: #e5e7eb;
      --gray-100: #f3f4f6;
      --gray-50: #f9fafb;
      --white: #ffffff;
      --green-600: #16a34a;
      --green-500: #22c55e;
      --green-100: #dcfce7;
      --red-600: #dc2626;
      --red-500: #ef4444;
      --red-100: #fee2e2;
      --yellow-600: #ca8a04;
      --yellow-500: #eab308;
      --yellow-100: #fef9c3;
      --purple-600: #9333ea;
      --purple-100: #f3e8ff;
      --orange-500: #f97316;
      --orange-100: #ffedd5;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--gray-50);
      color: var(--gray-900);
      line-height: 1.5;
      min-height: 100vh;
    }
    
    /* Login */
    .login-screen {
      position: fixed;
      top: 0; left: 0; right: 0; bottom: 0;
      background: linear-gradient(135deg, var(--blue-50) 0%, var(--white) 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      padding: 20px;
    }
    
    .login-screen.hidden { display: none; }
    
    .login-logo {
      width: 64px;
      height: 64px;
      background: var(--blue-500);
      border-radius: 16px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 2rem;
      margin-bottom: 20px;
    }
    
    .login-title {
      font-size: 1.75rem;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 4px;
    }
    
    .login-subtitle {
      font-size: 0.95rem;
      color: var(--gray-500);
      margin-bottom: 32px;
    }
    
    .login-box {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 16px;
      padding: 32px 40px;
      width: 100%;
      max-width: 360px;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
    }
    
    .login-label {
      font-size: 0.85rem;
      color: var(--gray-500);
      margin-bottom: 16px;
      display: block;
      text-align: center;
    }
    
    .pin-input-container {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-bottom: 8px;
    }
    
    .pin-digit {
      width: 56px;
      height: 64px;
      background: var(--white);
      border: 2px solid var(--gray-200);
      border-radius: 10px;
      font-size: 1.5rem;
      font-weight: 600;
      color: var(--gray-900);
      text-align: center;
    }
    
    .pin-digit:focus {
      outline: none;
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px var(--blue-100);
    }
    
    .pin-digit.error {
      border-color: var(--red-500);
      animation: shake 0.3s ease;
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-5px); }
      75% { transform: translateX(5px); }
    }
    
    .login-error {
      color: var(--red-500);
      font-size: 0.875rem;
      text-align: center;
      margin-top: 16px;
      opacity: 0;
      transition: opacity 0.2s;
    }
    
    .login-error.show { opacity: 1; }
    
    /* Main App */
    .main-app { display: none; }
    .main-app.visible { display: block; }
    
    /* Header */
    .header-bar {
      background: var(--white);
      border-bottom: 1px solid var(--gray-200);
      padding: 16px 24px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 100;
    }
    
    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .header-logo {
      width: 36px;
      height: 36px;
      background: var(--blue-500);
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.1rem;
    }
    
    .header-title {
      font-size: 1.1rem;
      font-weight: 700;
      color: var(--gray-900);
    }
    
    .header-title span {
      font-weight: 400;
      color: var(--gray-400);
      font-size: 0.85rem;
      margin-left: 8px;
    }
    
    .header-date {
      font-size: 0.8rem;
      color: var(--gray-500);
    }
    
    .header-actions {
      display: flex;
      gap: 8px;
      align-items: center;
    }
    
    .header-btn {
      padding: 8px 12px;
      background: var(--white);
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      color: var(--gray-700);
      font-size: 0.8rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 4px;
      font-family: inherit;
      transition: all 0.15s;
    }
    
    .header-btn:hover {
      background: var(--gray-50);
      border-color: var(--gray-400);
    }
    
    .header-btn.notify-on {
      border-color: var(--green-500);
      color: var(--green-600);
    }
    
    .msg-badge {
      background: var(--red-500);
      color: white;
      font-size: 0.7rem;
      font-weight: 700;
      padding: 2px 6px;
      border-radius: 10px;
      min-width: 18px;
      text-align: center;
    }
    
    /* Content */
    .content {
      padding: 20px 24px;
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Add Task */
    .add-task-box {
      display: flex;
      gap: 10px;
      align-items: center;
      padding: 16px;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }
    
    .add-task-input {
      flex: 1;
      min-width: 200px;
      padding: 10px 14px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.9rem;
      color: var(--gray-900);
      font-family: inherit;
    }
    
    .add-task-input:focus {
      outline: none;
      border-color: var(--blue-500);
      box-shadow: 0 0 0 3px var(--blue-100);
    }
    
    .add-task-input::placeholder {
      color: var(--gray-400);
    }
    
    .add-task-select {
      padding: 10px 12px;
      border: 1px solid var(--gray-300);
      border-radius: 6px;
      font-size: 0.85rem;
      color: var(--gray-700);
      background: var(--white);
      font-family: inherit;
      cursor: pointer;
    }
    
    .add-task-select:focus {
      outline: none;
      border-color: var(--blue-500);
    }
    
    .add-task-checkbox {
      display: flex;
      align-items: center;
      gap: 6px;
      font-size: 0.85rem;
      color: var(--gray-600);
      cursor: pointer;
      white-space: nowrap;
    }
    
    .add-task-checkbox input {
      accent-color: var(--blue-500);
      cursor: pointer;
      width: 16px;
      height: 16px;
    }
    
    .add-task-btn {
      padding: 10px 20px;
      background: var(--blue-500);
      border: none;
      border-radius: 6px;
      color: white;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      font-family: inherit;
      transition: background 0.15s;
    }
    
    .add-task-btn:hover {
      background: var(--blue-600);
    }
    
    /* Message Banner */
    .message-banner {
      display: none;
      background: var(--purple-100);
      border: 1px solid var(--purple-600);
      border-radius: 10px;
      padding: 16px;
      margin-bottom: 20px;
    }
    
    .message-banner.show { display: block; }
    
    .message-banner-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .message-banner-title {
      font-size: 0.9rem;
      font-weight: 600;
      color: var(--purple-600);
    }
    
    .message-banner-dismiss {
      background: none;
      border: none;
      color: var(--gray-400);
      cursor: pointer;
      font-size: 1.2rem;
    }
    
    .message-item {
      padding: 10px 0;
      border-bottom: 1px solid rgba(147, 51, 234, 0.2);
    }
    
    .message-item:last-child { border-bottom: none; padding-bottom: 0; }
    
    .message-from {
      font-size: 0.8rem;
      color: var(--purple-600);
      font-weight: 600;
      margin-bottom: 2px;
    }
    
    .message-content {
      font-size: 0.9rem;
      color: var(--gray-700);
    }
    
    .message-time {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 4px;
    }
    
    /* Sprint Banner */
    .sprint-banner {
      background: var(--white);
      border: 1px solid var(--blue-500);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .sprint-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    
    .sprint-name {
      font-size: 1rem;
      font-weight: 600;
      color: var(--gray-900);
    }
    
    .sprint-days {
      font-size: 0.85rem;
      color: var(--gray-500);
      font-weight: 500;
    }
    
    .sprint-days.urgent { color: var(--red-500); font-weight: 600; }
    .sprint-days.warning { color: var(--yellow-600); }
    
    .progress-bar {
      height: 8px;
      background: var(--gray-100);
      border-radius: 4px;
      overflow: hidden;
      margin-bottom: 10px;
    }
    
    .progress-fill {
      height: 100%;
      background: var(--green-500);
      border-radius: 4px;
      transition: width 0.3s;
    }
    
    .progress-fill.warning { background: var(--yellow-500); }
    .progress-fill.danger { background: var(--red-500); }
    
    .sprint-stats {
      font-size: 0.8rem;
      color: var(--gray-500);
      margin-bottom: 12px;
    }
    
    .objectives-row {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
    }
    
    .objective-chip {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: var(--gray-50);
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 0.8rem;
      color: var(--gray-700);
    }
    
    .objective-chip .icon { font-size: 0.9rem; }
    .objective-chip .count { color: var(--blue-600); font-weight: 600; }
    
    /* Sections */
    .section { margin-bottom: 24px; }
    
    .section-header {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
      padding: 10px 14px;
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 8px;
    }
    
    .section-header.active {
      background: var(--green-100);
      border-color: var(--green-500);
    }
    
    .section-header.overdue {
      background: var(--red-100);
      border-color: var(--red-500);
    }
    
    .section-header.sprint {
      background: var(--orange-100);
      border-color: var(--orange-500);
    }
    
    .section-header.incoming {
      background: var(--purple-100);
      border-color: var(--purple-600);
    }
    
    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      color: var(--gray-900);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .section-count {
      font-size: 0.8rem;
      color: var(--blue-600);
      font-weight: 600;
      background: var(--blue-100);
      padding: 2px 10px;
      border-radius: 12px;
    }
    
    /* Task Grid */
    .task-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 12px;
    }
    
    /* Task Card */
    .task-card {
      background: var(--white);
      border: 1px solid var(--gray-200);
      border-radius: 10px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      min-height: 120px;
      transition: all 0.15s;
    }
    
    .task-card:hover {
      border-color: var(--gray-300);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
    }
    
    .task-card.active {
      border-color: var(--green-500);
      background: linear-gradient(135deg, var(--green-100) 0%, var(--white) 100%);
    }
    
    .task-card.overdue {
      border-left: 4px solid var(--red-500);
    }
    
    .task-card.in-sprint {
      border-left: 4px solid var(--orange-500);
    }
    
    .task-card.incoming {
      border-left: 4px solid var(--purple-600);
    }
    
    .task-text {
      font-size: 0.9rem;
      color: var(--gray-900);
      line-height: 1.5;
      flex: 1;
      margin-bottom: 12px;
    }
    
    .task-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 12px;
    }
    
    .task-tag {
      font-size: 0.7rem;
      padding: 3px 8px;
      border-radius: 4px;
      background: var(--gray-100);
      color: var(--gray-600);
      font-weight: 500;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }
    
    .task-tag.due {
      background: var(--yellow-100);
      color: var(--yellow-600);
    }
    
    .task-tag.due.overdue {
      background: var(--red-100);
      color: var(--red-600);
    }
    
    .task-tag.objective {
      background: var(--orange-100);
      color: var(--orange-500);
    }
    
    .task-tag.category {
      background: var(--gray-100);
      color: var(--gray-500);
    }
    
    .task-tag.handoff {
      background: var(--purple-100);
      color: var(--purple-600);
    }
    
    .task-actions {
      display: flex;
      gap: 8px;
      margin-top: auto;
    }
    
    .task-btn {
      flex: 1;
      padding: 8px 12px;
      border-radius: 6px;
      border: 1px solid var(--gray-300);
      background: var(--white);
      color: var(--gray-600);
      font-size: 0.8rem;
      font-weight: 500;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 4px;
      font-family: inherit;
      transition: all 0.15s;
    }
    
    .task-btn:hover {
      border-color: var(--gray-400);
      background: var(--gray-50);
    }
    
    .task-btn.complete {
      border-color: var(--green-500);
      color: var(--green-600);
    }
    
    .task-btn.complete:hover {
      background: var(--green-500);
      color: white;
    }
    
    .task-btn.activate {
      border-color: var(--blue-500);
      color: var(--blue-600);
    }
    
    .task-btn.activate:hover {
      background: var(--blue-500);
      color: white;
    }
    
    .task-btn.deactivate {
      border-color: var(--gray-300);
      color: var(--gray-500);
    }
    
    .task-btn.deactivate:hover {
      background: var(--gray-200);
    }
    
    .task-btn.claim {
      border-color: var(--purple-600);
      color: var(--purple-600);
    }
    
    .task-btn.claim:hover {
      background: var(--purple-600);
      color: white;
    }
    
    .task-btn.completing {
      background: var(--green-500);
      color: white;
      pointer-events: none;
    }
    
    /* Category Label */
    .category-label {
      grid-column: 1 / -1;
      font-size: 0.8rem;
      font-weight: 600;
      color: var(--gray-500);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      padding: 12px 0 6px;
      border-bottom: 1px solid var(--gray-200);
      margin-top: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .category-label:first-child { margin-top: 0; }
    
    .category-count {
      font-size: 0.75rem;
      color: var(--blue-600);
      background: var(--blue-100);
      padding: 2px 8px;
      border-radius: 10px;
    }
    
    /* Empty State */
    .empty-state {
      grid-column: 1 / -1;
      text-align: center;
      padding: 40px 20px;
      color: var(--gray-400);
      font-size: 0.9rem;
      background: var(--white);
      border: 1px dashed var(--gray-300);
      border-radius: 10px;
    }
    
    /* Toast */
    .toast {
      position: fixed;
      bottom: 24px;
      left: 50%;
      transform: translateX(-50%);
      background: var(--gray-900);
      color: white;
      padding: 12px 24px;
      border-radius: 8px;
      font-size: 0.9rem;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s;
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
    }
    
    .toast.show { opacity: 1; }
    .toast.success { background: var(--green-600); }
    .toast.error { background: var(--red-500); }
    
    /* Loading */
    .loading {
      grid-column: 1 / -1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 40px;
      color: var(--gray-400);
    }
    
    .spinner {
      width: 20px;
      height: 20px;
      border: 2px solid var(--gray-200);
      border-top-color: var(--blue-500);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }
    
    @keyframes spin { to { transform: rotate(360deg); } }
    
    /* Responsive */
    @media (max-width: 600px) {
      .task-grid { grid-template-columns: 1fr; }
      .content { padding: 16px; }
      .add-task-box { flex-direction: column; align-items: stretch; }
      .add-task-input { min-width: 100%; }
      .header-actions { gap: 4px; }
      .header-btn { padding: 6px 8px; font-size: 0.75rem; }
    }
  </style>
</head>
<body>
  <div class="login-screen" id="loginScreen">
    <div class="login-logo">‚öôÔ∏è</div>
    <div class="login-title">Helm</div>
    <div class="login-subtitle">Productivity Dashboard</div>
    <div class="login-box">
      <label class="login-label">Enter your PIN</label>
      <div class="pin-input-container">
        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
        <input type="password" class="pin-digit" maxlength="1" inputmode="numeric">
      </div>
      <div class="login-error" id="loginError">Invalid PIN</div>
    </div>
  </div>

  <div class="main-app" id="mainApp">
    <div class="header-bar">
      <div class="header-left">
        <div class="header-logo">‚öôÔ∏è</div>
        <div>
          <div class="header-title">Helm <span>Productivity</span></div>
          <div class="header-date" id="dateInfo">Loading...</div>
        </div>
      </div>
      <div class="header-actions">
        <button class="header-btn" onclick="window.open('https://mrmicaiah.github.io/up-infrastructure/email-bot/dashboard.html', '_blank')" title="Courier">üìß</button>
        <button class="header-btn" id="msgBtn" onclick="showMessages()" style="display:none;">üí¨ <span id="msgBadge" class="msg-badge">0</span></button>
        <button class="header-btn" id="notifyBtn" onclick="toggleNotifications()">üîî Off</button>
        <button class="header-btn" onclick="loadData()">‚Üª Refresh</button>
        <button class="header-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    
    <div class="content">
      <div class="message-banner" id="messageBanner">
        <div class="message-banner-header">
          <span class="message-banner-title">üí¨ New Messages</span>
          <button class="message-banner-dismiss" onclick="dismissMessages()">‚úï</button>
        </div>
        <div id="messageList"></div>
      </div>
      
      <div class="add-task-box">
        <input type="text" class="add-task-input" id="newTaskInput" placeholder="What needs to be done?">
        <select class="add-task-select" id="newTaskCategory">
          <option value="General">General</option>
        </select>
        <label class="add-task-checkbox">
          <input type="checkbox" id="newTaskActive"> Active
        </label>
        <button class="add-task-btn" onclick="addTask()">Add Task</button>
      </div>
      
      <div class="sprint-banner" id="sprintBanner" style="display: none;">
        <div class="sprint-top">
          <div class="sprint-name" id="sprintName">Sprint</div>
          <div class="sprint-days" id="sprintDays">0 days</div>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" id="sprintProgress"></div>
        </div>
        <div class="sprint-stats" id="sprintStats">0/0 tasks</div>
        <div class="objectives-row" id="objectivesList"></div>
      </div>
      
      <div class="section" id="incomingSection" style="display: none;">
        <div class="section-header incoming">
          <span class="section-title">üì• Incoming</span>
          <span class="section-count" id="incomingCount">0</span>
        </div>
        <div class="task-grid" id="incomingTasks"></div>
      </div>
      
      <div class="section" id="activeSection">
        <div class="section-header active">
          <span class="section-title">üéØ Active</span>
          <span class="section-count" id="activeCount">0</span>
        </div>
        <div class="task-grid" id="activeTasks">
          <div class="loading"><div class="spinner"></div> Loading tasks...</div>
        </div>
      </div>
      
      <div class="section" id="overdueSection" style="display: none;">
        <div class="section-header overdue">
          <span class="section-title">‚ö†Ô∏è Overdue</span>
          <span class="section-count" id="overdueCount">0</span>
        </div>
        <div class="task-grid" id="overdueTasks"></div>
      </div>
      
      <div class="section" id="sprintTasksSection" style="display: none;">
        <div class="section-header sprint">
          <span class="section-title">üìå Sprint Queue</span>
          <span class="section-count" id="sprintTasksCount">0</span>
        </div>
        <div class="task-grid" id="sprintTasks"></div>
      </div>
      
      <div class="section">
        <div class="section-header">
          <span class="section-title">üìã Backlog</span>
          <span class="section-count" id="backlogCount">0</span>
        </div>
        <div class="task-grid" id="backlogTasks"></div>
      </div>
    </div>
  </div>
  
  <div class="toast" id="toast"></div>
  
  <script>
    const USER_CONFIG = {
      '1987': { name: 'Micaiah', api: 'https://productivity-mcp-server.micaiah-tasks.workers.dev/api' },
      '1976': { name: 'Irene', api: 'https://productivity-irene.micaiah-tasks.workers.dev/api' }
    };
    
    let API_URL = '', API_KEY = '', currentUser = '', categories = ['General'];
    let notificationsEnabled = false, checkInterval = null;
    let lastIncomingCount = -1, lastOverdueIds = new Set(), lastMessageCount = -1, currentMessages = [];
    
    // Notification functions
    async function requestNotificationPermission() {
      if (!('Notification' in window)) return false;
      if (Notification.permission === 'granted') return true;
      if (Notification.permission === 'denied') return false;
      return await Notification.requestPermission() === 'granted';
    }
    
    function sendNotification(title, body, tag) {
      if (!notificationsEnabled || Notification.permission !== 'granted') return;
      try { new Notification(title, { body, tag, requireInteraction: false }); } catch (e) {}
    }
    
    async function toggleNotifications() {
      const btn = document.getElementById('notifyBtn');
      if (!notificationsEnabled) {
        if (await requestNotificationPermission()) {
          notificationsEnabled = true;
          localStorage.setItem('notificationsEnabled', 'true');
          btn.textContent = 'üîî On';
          btn.classList.add('notify-on');
          startBackgroundCheck();
          showToast('Notifications enabled');
        }
      } else {
        notificationsEnabled = false;
        localStorage.setItem('notificationsEnabled', 'false');
        btn.textContent = 'üîî Off';
        btn.classList.remove('notify-on');
        stopBackgroundCheck();
        showToast('Notifications disabled');
      }
    }
    
    function startBackgroundCheck() {
      if (checkInterval) return;
      checkInterval = setInterval(checkForNotifications, 30000);
      checkForNotifications();
    }
    
    function stopBackgroundCheck() {
      if (checkInterval) { clearInterval(checkInterval); checkInterval = null; }
    }
    
    async function checkForNotifications() {
      if (!notificationsEnabled || !API_URL) return;
      try {
        const data = await api('/morning');
        if (!data) return;
        
        const msgCount = data.unreadMessages || 0;
        if (lastMessageCount !== -1 && msgCount > lastMessageCount) {
          sendNotification('üí¨ New Message', 'You have a new message!', 'message-' + Date.now());
        }
        lastMessageCount = msgCount;
        
        const incomingCount = data.incomingCount || (data.incoming || []).length;
        if (lastIncomingCount !== -1 && incomingCount > lastIncomingCount) {
          sendNotification('üì• New Task', 'You have a new task from your teammate!', 'incoming-' + Date.now());
        }
        lastIncomingCount = incomingCount;
        
        const overdue = data.overdueTasks || [];
        const currentOverdueIds = new Set(overdue.map(t => t.id));
        for (const task of overdue) {
          if (!lastOverdueIds.has(task.id)) {
            sendNotification('‚ö†Ô∏è Task Overdue', task.text.substring(0, 100), 'overdue-' + task.id);
          }
        }
        lastOverdueIds = currentOverdueIds;
      } catch (e) {}
    }
    
    function initNotifications() {
      const saved = localStorage.getItem('notificationsEnabled');
      const btn = document.getElementById('notifyBtn');
      if (saved === 'true' && Notification.permission === 'granted') {
        notificationsEnabled = true;
        btn.textContent = 'üîî On';
        btn.classList.add('notify-on');
        startBackgroundCheck();
      }
    }
    
    // Message functions
    async function fetchMessages() {
      const data = await api('/messages');
      if (!data) return;
      currentMessages = data.messages || [];
      updateMessageUI();
    }
    
    function updateMessageUI() {
      const count = currentMessages.length;
      const msgBtn = document.getElementById('msgBtn');
      const msgBadge = document.getElementById('msgBadge');
      if (count > 0) {
        msgBtn.style.display = 'flex';
        msgBadge.textContent = count;
      } else {
        msgBtn.style.display = 'none';
      }
    }
    
    function showMessages() {
      if (currentMessages.length === 0) return;
      const banner = document.getElementById('messageBanner');
      const list = document.getElementById('messageList');
      list.innerHTML = currentMessages.map(m => `
        <div class="message-item">
          <div class="message-from">${esc(m.from_user)}</div>
          <div class="message-content">${esc(m.content)}</div>
          <div class="message-time">${formatRelativeTime(m.created_at)}</div>
        </div>
      `).join('');
      banner.classList.add('show');
    }
    
    async function dismissMessages() {
      document.getElementById('messageBanner').classList.remove('show');
      await api('/messages/read', { method: 'POST' });
      currentMessages = [];
      updateMessageUI();
      lastMessageCount = 0;
    }
    
    function formatRelativeTime(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMins / 60);
      const diffDays = Math.floor(diffHours / 24);
      if (diffMins < 1) return 'just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    // Session management
    function checkSession() {
      const s = localStorage.getItem('dashboardSession');
      if (s) {
        const { pin, timestamp } = JSON.parse(s);
        if (Date.now() - timestamp < 7*24*60*60*1000 && USER_CONFIG[pin]) {
          currentUser = USER_CONFIG[pin].name;
          API_KEY = pin;
          API_URL = USER_CONFIG[pin].api;
          showMainApp();
          return true;
        }
      }
      return false;
    }
    
    // PIN input handling
    const pinInputs = document.querySelectorAll('.pin-digit');
    pinInputs.forEach((input, i) => {
      input.addEventListener('input', e => {
        if (e.target.value && i < 3) pinInputs[i+1].focus();
        if (i === 3 && e.target.value) attemptLogin();
      });
      input.addEventListener('keydown', e => {
        if (e.key === 'Backspace' && !e.target.value && i > 0) pinInputs[i-1].focus();
      });
    });
    
    function attemptLogin() {
      const pin = Array.from(pinInputs).map(i => i.value).join('');
      if (USER_CONFIG[pin]) {
        currentUser = USER_CONFIG[pin].name;
        API_KEY = pin;
        API_URL = USER_CONFIG[pin].api;
        localStorage.setItem('dashboardSession', JSON.stringify({ pin, timestamp: Date.now() }));
        showMainApp();
      } else {
        document.getElementById('loginError').classList.add('show');
        pinInputs.forEach(input => { input.classList.add('error'); input.value = ''; });
        pinInputs[0].focus();
        setTimeout(() => {
          document.getElementById('loginError').classList.remove('show');
          pinInputs.forEach(input => input.classList.remove('error'));
        }, 2000);
      }
    }
    
    function showMainApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.add('visible');
      initNotifications();
      loadData();
      fetchMessages();
    }
    
    function logout() {
      stopBackgroundCheck();
      localStorage.removeItem('dashboardSession');
      location.reload();
    }
    
    // API helper
    async function api(endpoint, options = {}) {
      const headers = { 'Content-Type': 'application/json', 'Authorization': `Bearer ${API_KEY}` };
      try {
        const r = await fetch(`${API_URL}${endpoint}`, { ...options, headers });
        if (!r.ok) throw new Error(r.status);
        return await r.json();
      } catch (e) { console.error(e); return null; }
    }
    
    function updateCategoryDropdown() {
      const select = document.getElementById('newTaskCategory');
      const current = select.value;
      select.innerHTML = categories.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join('');
      if (categories.includes(current)) select.value = current;
    }
    
    // Add task
    async function addTask() {
      const input = document.getElementById('newTaskInput');
      const text = input.value.trim();
      if (!text) return;
      
      const category = document.getElementById('newTaskCategory').value;
      const isActive = document.getElementById('newTaskActive').checked;
      
      const r = await api('/tasks', { method: 'POST', body: JSON.stringify({ text, category, priority: 3 }) });
      if (r?.success) {
        if (isActive && r.id) {
          await api(`/tasks/${r.id}/activate`, { method: 'POST' });
        }
        input.value = '';
        document.getElementById('newTaskActive').checked = false;
        showToast('Task added' + (isActive ? ' & activated' : ''));
        loadData();
      }
    }
    
    // Handle Enter key
    document.getElementById('newTaskInput')?.addEventListener('keydown', e => {
      if (e.key === 'Enter') addTask();
    });
    
    // Load data
    async function loadData() {
      const data = await api('/morning');
      if (!data) return;
      
      // Update header
      const hour = new Date().getHours();
      document.getElementById('dateInfo').textContent = `${data.greeting.dayOfWeek} ‚Ä¢ ${data.greeting.date}`;
      
      // Init tracking
      if (lastIncomingCount === -1) lastIncomingCount = data.incomingCount || (data.incoming || []).length;
      if (lastMessageCount === -1) lastMessageCount = data.unreadMessages || 0;
      lastOverdueIds = new Set((data.overdueTasks || []).map(t => t.id));
      
      // Messages
      if (data.unreadMessages > 0) {
        document.getElementById('msgBtn').style.display = 'flex';
        document.getElementById('msgBadge').textContent = data.unreadMessages;
      } else {
        document.getElementById('msgBtn').style.display = 'none';
      }
      
      // Categories
      const backlog = data.backlogByCategory || {};
      const cats = Object.keys(backlog);
      categories = ['General', ...cats.filter(c => c !== 'General')];
      categories = [...new Set(categories)];
      updateCategoryDropdown();
      
      // Sprint
      if (data.sprint) {
        document.getElementById('sprintBanner').style.display = 'block';
        document.getElementById('sprintName').textContent = 'üèÉ ' + data.sprint.name;
        
        const daysEl = document.getElementById('sprintDays');
        daysEl.textContent = data.sprint.daysRemaining + ' days left';
        daysEl.className = 'sprint-days' + (data.sprint.daysRemaining <= 3 ? ' urgent' : data.sprint.daysRemaining <= 7 ? ' warning' : '');
        
        const objs = data.sprint.objectives || [];
        let total = 0, done = 0;
        objs.forEach(o => { total += o.totalTasks || 0; done += o.doneTasks || 0; });
        const pct = total > 0 ? Math.round(done/total*100) : 0;
        
        const prog = document.getElementById('sprintProgress');
        prog.style.width = pct + '%';
        prog.className = 'progress-fill' + (pct < 30 ? ' danger' : pct < 70 ? ' warning' : '');
        
        document.getElementById('sprintStats').textContent = `${done}/${total} tasks completed (${pct}%)`;
        
        document.getElementById('objectivesList').innerHTML = objs.map(o => {
          const icon = o.doneTasks === o.totalTasks && o.totalTasks > 0 ? '‚úÖ' : o.doneTasks > 0 ? '‚óê' : '‚óã';
          return `<div class="objective-chip"><span class="icon">${icon}</span><span>${esc(o.statement)}</span><span class="count">${o.doneTasks}/${o.totalTasks}</span></div>`;
        }).join('');
      } else {
        document.getElementById('sprintBanner').style.display = 'none';
      }
      
      // Incoming
      const incoming = data.incoming || [];
      document.getElementById('incomingCount').textContent = incoming.length;
      document.getElementById('incomingSection').style.display = incoming.length ? 'block' : 'none';
      document.getElementById('incomingTasks').innerHTML = incoming.map(t => incomingTaskCard(t)).join('');
      
      // Active
      const active = data.activeTasks || [];
      document.getElementById('activeCount').textContent = active.length;
      document.getElementById('activeTasks').innerHTML = active.length === 0
        ? '<div class="empty-state">No active tasks ‚Äî activate something from your backlog!</div>'
        : active.map(t => taskCard(t, true)).join('');
      
      // Overdue
      const overdue = data.overdueTasks || [];
      document.getElementById('overdueCount').textContent = overdue.length;
      document.getElementById('overdueSection').style.display = overdue.length ? 'block' : 'none';
      document.getElementById('overdueTasks').innerHTML = overdue.map(t => taskCard(t, false, true)).join('');
      
      // Sprint tasks
      const sprintTasks = (data.sprintTasks || []).filter(t => !t.is_active);
      document.getElementById('sprintTasksCount').textContent = sprintTasks.length;
      document.getElementById('sprintTasksSection').style.display = sprintTasks.length ? 'block' : 'none';
      document.getElementById('sprintTasks').innerHTML = sprintTasks.map(t => taskCard(t, false, false, true)).join('');
      
      // Backlog
      let backlogTotal = 0;
      cats.forEach(c => backlogTotal += backlog[c].length);
      document.getElementById('backlogCount').textContent = backlogTotal;
      
      if (cats.length === 0) {
        document.getElementById('backlogTasks').innerHTML = '<div class="empty-state">Backlog is empty</div>';
      } else {
        let html = '';
        cats.forEach(cat => {
          const tasks = backlog[cat];
          html += `<div class="category-label">${esc(cat)} <span class="category-count">${tasks.length}</span></div>`;
          html += tasks.map(t => taskCard(t, false)).join('');
        });
        document.getElementById('backlogTasks').innerHTML = html;
      }
    }
    
    function incomingTaskCard(task) {
      let meta = `<span class="task-tag handoff">from ${esc(task.assigned_by)}</span>`;
      if (task.due_date) {
        const od = new Date(task.due_date) < new Date(new Date().toDateString());
        meta += `<span class="task-tag due ${od ? 'overdue' : ''}">${fmtDate(task.due_date)}</span>`;
      }
      if (task.category) meta += `<span class="task-tag category">${esc(task.category)}</span>`;
      
      return `
        <div class="task-card incoming" data-id="${task.id}">
          <div class="task-text">${esc(task.text)}</div>
          <div class="task-meta">${meta}</div>
          <div class="task-actions">
            <button class="task-btn claim" onclick="claimTask('${task.id}')">‚úì Claim</button>
            <button class="task-btn complete" onclick="complete('${task.id}', this)">‚úì Done</button>
          </div>
        </div>
      `;
    }
    
    function taskCard(task, isActive, isOverdue = false, inSprint = false) {
      const classes = ['task-card'];
      if (isActive) classes.push('active');
      if (isOverdue) classes.push('overdue');
      if (inSprint || task.objective_id) classes.push('in-sprint');
      
      let meta = '';
      if (task.due_date) {
        const od = new Date(task.due_date) < new Date(new Date().toDateString());
        meta += `<span class="task-tag due ${od ? 'overdue' : ''}">${fmtDate(task.due_date)}</span>`;
      }
      if (task.category) meta += `<span class="task-tag category">${esc(task.category)}</span>`;
      if (task.objective_statement) meta += `<span class="task-tag objective">‚Üí ${esc(task.objective_statement)}</span>`;
      if (task.assigned_by) meta += `<span class="task-tag handoff">from ${esc(task.assigned_by)}</span>`;
      
      return `
        <div class="${classes.join(' ')}" data-id="${task.id}">
          <div class="task-text">${esc(task.text)}</div>
          <div class="task-meta">${meta}</div>
          <div class="task-actions">
            ${isActive
              ? `<button class="task-btn deactivate" onclick="deactivate('${task.id}')">‚àí Remove</button>`
              : `<button class="task-btn activate" onclick="activate('${task.id}')">‚òÖ Activate</button>`
            }
            <button class="task-btn complete" onclick="complete('${task.id}', this)">‚úì Done</button>
          </div>
        </div>
      `;
    }
    
    // Task actions
    async function claimTask(id) {
      const r = await api(`/tasks/${id}/claim`, { method: 'POST' });
      if (r?.success) { showToast('Task claimed'); loadData(); }
    }
    
    async function complete(id, btn) {
      btn.classList.add('completing');
      btn.innerHTML = '...';
      const r = await api(`/tasks/${id}/complete`, { method: 'POST' });
      if (r?.success) {
        showToast('Completed ‚úì');
        setTimeout(loadData, 400);
      } else {
        btn.classList.remove('completing');
        btn.innerHTML = '‚úì Done';
      }
    }
    
    async function activate(id) {
      const r = await api(`/tasks/${id}/activate`, { method: 'POST' });
      if (r?.success) { showToast('Activated'); loadData(); }
    }
    
    async function deactivate(id) {
      const r = await api(`/tasks/${id}/deactivate`, { method: 'POST' });
      if (r?.success) { showToast('Deactivated'); loadData(); }
    }
    
    // Helpers
    function fmtDate(d) {
      return new Date(d).toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }
    
    function esc(s) {
      return s ? s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;') : '';
    }
    
    function showToast(msg, type = 'success') {
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.className = `toast show ${type}`;
      setTimeout(() => t.classList.remove('show'), 3000);
    }
    
    // Init
    if (!checkSession()) pinInputs[0].focus();
  </script>
</body>
</html>
